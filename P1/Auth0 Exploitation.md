



OAuth is an open-standard authorization protocol or framework that provides applications the ability for “secure designated access.”


~={cyan}Easy Step By step Exploitation:=~

1 – Go to https://www.example.com  
2 – Register on the target using victim@gmail.com using email registration  
3 – A verification process will be done (==don’t verify it==)  
4 – Now, victim will use his Oauth account (victim@gmail.com) for registration, he will be logged in  
5 – The attacker can now login into the victim’s account using normal login (email and password) and the victim can use the same account using Oauth.


Alright, let's break this down:

1. **Step 2**: When it says "register on the target using victim@gmail.com using email registration," it means you should create an account on the target website using the victim's email address (victim@gmail.com). This typically involves entering the email address and setting a password, but not verifying the email.
    
2. **Step 4**: The victim then uses their OAuth account (like Google, Facebook, etc.) to register on the same website using the same email address (victim@gmail.com). **This means the victim logs in using their OAuth provider, which automatically creates an account on the target website linked to their OAuth credentials.**
    
3. **Step 5**: Since the victim's account is now created and linked to their OAuth provider, the attacker can log in to the victim's account using the email and password set in step 2. The victim can also log in using their OAuth provider.
    

So, in step 2, it means normal email registration (entering email and password but not verifying the email). 

In step 4, the victim uses their OAuth account to log in, which creates the account on the target website. 

**The victim does not need to be logged in for the attacker to proceed to step 5.**


## Brief Explanation:

The vulnerability here is that the attacker creates the password during the initial registration process. Here's a clearer breakdown:

1. **Step 2**: The attacker registers on the target website using the victim's email address (victim@gmail.com) and sets a password. The email verification step is not completed, so the account is not fully activated.
    
2. **Step 4**: The victim then uses their OAuth account (like Google, Facebook, etc.) to log in to the same website using the same email address (victim@gmail.com). This creates an account on the target website linked to their OAuth credentials.
    
3. **Step 5**: Since the attacker set the password during the initial registration, they can now log in to the victim's account using the email and password they set. **The victim can also log in using their OAuth provider.**
    

**The vulnerability lies in the fact that the attacker can create an account with the victim's email address and set a password without verifying the email.** This allows the attacker to gain access to the victim's account once the victim logs in using their OAuth provider.

**==Impact:-==** OAuth misconfiguration lead to pre-account takeover, granting attackers unauthorized access to user accounts and sensitive data. ~={green}This breach can result in data theft, financial loss, and erosion of user trust. The exploited accounts may be used for further attacks, including phishing and social engineering.=~ Legal and compliance issues may arise due to failure in protecting user data. Overall, the impact can be severe, affecting both users and the organization’s reputation and finances.

Check reports of OAuth Misconfiguration Pre-Account Takeover

>[https://hackerone.com/reports/1074047](https://hackerone.com/reports/1074047)

>[https://hackerone.com/reports/1212374](https://hackerone.com/reports/1212374)

----

## Reports:


> _During our comprehensive testing of the application, my friend Kareem AlSadeq (_[_https://k_areemelsadek.github.io](https://kareemelsadek.github.io)_) and I discovered and exploited this vulnerability._

# Introduction

In the realm of application security, authentication mechanisms play a pivotal role in safeguarding user data.


Leveraging robust authentication services like Auth0 can significantly enhance security. However, misconfigurations within these services can introduce critical vulnerabilities. In this article, **we delve into a recent discovery of a severe vulnerability related to Auth0 misconfiguration in an application we were testing.**


# Background: Understanding Auth0 and Social Logins

Auth0 is a widely used authentication and authorization platform that simplifies the implementation of secure login systems. It supports various authentication methods, including social logins like Google, Facebook, and others. Social logins offer users the convenience of signing up and logging in using their existing social media accounts, reducing the friction of creating new credentials.

However, the integration of social logins requires meticulous configuration to ensure that user data is handled securely. **Misconfigurations can lead to vulnerabilities such as account linking issues, where multiple accounts inadvertently reference the same user data.**


# The Application Under Test

The application in question limited user registration exclusively to Google accounts through the “Signup with Google” option. This singular authentication pathway streamlined the user experience but also concentrated the authentication process within a single framework — Auth0.

# Discovery of the Vulnerability

During testing, we identified a significant vulnerability stemming from a misconfiguration in Auth0. The application exhibited unintended behavior when users attempted to create accounts using the same email address through different authentication methods. Specifically, ~={yellow}**creating an account via Google and then attempting to register with the same email using email and password led to unexpected account linking or data retrieval issues.**=~


# Reasons Behind the Vulnerability

There are two primary reasons for this behavior:

**1. User Data Retrieval Based on Email:**

- The application fetches user data based on the email present in the `Access_token` or `Id_token`. Consequently, when a user attempts to create a new account with an existing email, the system retrieves and returns data from the original account.

**2. Account Linking**

- **Developer Misconfiguration:  
    **The unintended account linking occurs due to misconfigurations made by the developers within the Auth0 setup. Specifically, when a user attempts to register multiple accounts using the same email address through different authentication methods (e.g., signing up with Google and then with email and password), the system erroneously links these accounts as one.

- This linkage happens because the developers did not implement the necessary safeguards or utilize the appropriate tools to manage account associations correctly.
- **Auth0 Extension for Account Linking:  
    **Auth0 provides an **Account Linking** extension designed to handle the association of multiple authentication methods to a single user profile securely. This extension ensures that account linking is performed intentionally and securely, preventing accidental or unauthorized linking of user accounts.

> Detailed Steps to Identify and Exploit the Vulnerability

# Step 1: Account Creation via Social Login

We began by creating an account using the available “Signup with Google” option. This established the initial user profile within the application’s authentication system.

# Step 2: Attempting Email and Password Registration

Next, we attempted to create a new account using the same email address (`testacc2399@gmail.com`) and a password (`testA@123`) through the public sign-up endpoint associated with Auth0. However, encountered an issue where the `dbconnection` parameter was either incorrect or not linked to the application, preventing successful account creation.

# Step 3: Exploiting Misconfiguration to Identify dbconnection

To bypass the misconfiguration, we employed a technique to identify the correct `dbconnection` tied to the application under test. Once obtained the `dbconnection` name, we crafted a specific HTTP POST request using Burp Suite:

```bash
POST /dbconnections/signup HTTP/2  
Host: auth.test.ai  
Content-Length: 224  
Content-Type: application/json  
Origin: https://auth.test.ai  
Referer: https://auth.test.ai/  
  
{  
  "client_id": "XXXXXXXXXXXXXXXXXXXX",  
  "email": "testacc2399@gmail.com",  
  "password": "testA@123",  
  "connection": "app-prod-users",  
  "credential_type": "http://auth0.com/oauth/grant-type/password-realm"  
}
```

**Important Note:** For the request to be successful, both the `Host` and `client_id` must be accurate.


# Step 4: Creating the Second Account

Using the identified `dbconnection`, we submitted the above request. The application accepted the request, creating a new account associated with the same email (`testacc2399@gmail.com`). **This indicated that the system allowed multiple accounts with the same email across different authentication methods, leading to potential data conflicts.**

# Step 5: Verifying Account Linking

To confirm whether the two accounts were linked or if the system fetched data based on the email, we performed the following actions:

1. **Accessing the Account via Email and Password:**

- **Initial Challenge:** Initially, we faced a challenge: the application did not provide a direct page or interface to log in using email and password. The only available option was to log in via Google.
- **Overcoming the Challenge:** To overcome this, we manipulated the authorization endpoint URL to force the authentication method to email and password:  
    `https://{auth.app.xx}/authorize?client_id={Clientid}&response_type=token&connection={dbconnection}&prompt=login&scope=openid%20profile%20phone&redirect_uri={redirect-uri}`

![](https://miro.medium.com/v2/resize:fit:700/1*YS68EwzhIah-o9yM1Gml7w.png)

- **Result:** Accessing this modified URL prompted a login page where we could enter the email and password. Upon submission, the login redirected us to the original account created via Google, confirming that the system recognized both authentication methods as a single user profile.

----

# No email verification leads to an Oauth account takeover.

**So let's see**

**After creating my account and logging into my account successfully.**

**I clicked on account settings**

![None](https://miro.medium.com/v2/resize:fit:700/1*TnAPxKx34y4c7lN7Y1wh0g.png)

**After I clicked on change email & password**

![None](https://miro.medium.com/v2/resize:fit:700/1*W3WKJRb_7JXMjRJJQj9LjQ.png)


**After Entering a new email and my current password I clicked on Change email**

![None](https://miro.medium.com/v2/resize:fit:700/1*BFZJIJvS1mBzipWmy5sqvg.png)

**You can see in the below image no confirmation link was sent.**

![None](https://miro.medium.com/v2/resize:fit:700/1*RkDVFze0c5P2zhjPx-lVjw.png)


**My new email was changed without confirmation**

![None](https://miro.medium.com/v2/resize:fit:700/1*hyazoK_cgt3XAIckxTKUng.png)

**I'm logged out from my account**

![None](https://miro.medium.com/v2/resize:fit:700/1*sdhGZtAmWOx8zWbEq_OLlg.png)

**Now I'm trying to log in with Google**

![None](https://miro.medium.com/v2/resize:fit:700/1*DKEELJ8vHg3VSm2RAinZMA.png)

![None](https://miro.medium.com/v2/resize:fit:700/1*7cP0z9fbftInZ5_GA7b2-A.png)

**After I clicked on continue.**

**I'm successfully logged in**

![None](https://miro.medium.com/v2/resize:fit:700/1*V6vFoN1TOxGR0l7-bX5-Bw.png)



![None](https://miro.medium.com/v2/resize:fit:700/1*vW64nEXdxBxIuiTxZ_TF4g.png)

> IMPACT

OAuth account takeover can have significant consequences, including identity theft, financial fraud, and unauthorized access to personal information like credit card numbers, private messages, and health records.

Attackers exploit vulnerabilities in OAuth implementations to gain control of user accounts For example, a flaw in Google's OAuth implementation allows the takeover of old employee accounts when domain ownership changes. By purchasing a failed startup's domain, an attacker can recreate old employee email accounts and use them to access various SaaS products the startup used, potentially exposing sensitive personal and internal information

> MITIGATION

_Send an email verification link to the new email._

_Send an OTP to the new email._

---


##  OAuth Hijacking leads to account takeover

# **What is GOOGLE One Tap Sign-In?**

> Google One Tap is a new feature that allows users to create an account or log in to the website with a single click. It is also known as **YOLO (You Only Login Once)**.

The login widget appears as a popup, and it will prompt the users to sign in or sign up with the existing Google account.

![](https://miro.medium.com/v2/resize:fit:700/1*Qelbdu0akjp3i6zDXmWZPA.png)

# **How Does GOOGLE One Tap Sign-In Work?**

A JavaScript library is included on your website. HTML or JavaScript is used to customize the look and feel of the personalized button and, on one tap, control the automatic sign-in and sign-out behaviors.

The Users who are signing in for the first time are prompted for consent to share their Google Account profile information. After providing the consent, a JSON Web Token (JWT) credential containing the user’s name, email, and profile picture is shared using a callback handler.

Now you can use the **ID token** to create a new account on your platform or allow the verified user to continue using your site.

Source: [https://www.loginradius.com/blog/identity/google-one-tap-login/](https://www.loginradius.com/blog/identity/google-one-tap-login/)

## **In the server-side, how does the developer deal with the ID token in order to verify if this token is for a person who is already registered in the application or not?**

**_At first, what’s inside in the ID token Payload?_**{  
"iss": "https://accounts.google.com",  
"azp": "xxxxxxxxxxxxx.apps.googleusercontent.com",  
"aud": "xxxxxxxxxxxxx.apps.googleusercontent.com",  
"sub": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",  
"at_hash": "xxxxxxxxxxxxxxxxxxx",  
"hd": "example.com",  
"email": "abushadad@example.com",  
"email_verified": "true",  
"iat": 1353601026,  
"exp": 1353604926,  
"nonce": "xxxxxxxxxxxxxxxx"  
}

```perl
iss (issuer): Issuer of the JWT (Google)  
sub (subject): Subject of the JWT (the user)  
aud (audience): Recipient for which the JWT is intended (The Client)  
exp (expiration time): Time after which the JWT expires  
iat (issued at time): Time at which the JWT was issued; can be used to determine age of the JWT  
jti (JWT ID): Unique identifier; can be used to prevent the JWT from being replayed (allows a token to be used only once)
```

**Now, Validation of an ID token in the back-end requires several steps:**

1. Verify that the ID token is properly signed by the issuer.
2. Verify that the value of the `iss` claim in the ID token is equal to `https://accounts.google.com` or `accounts.google.com`
3. **Verify that the value of the** `**aud**` **claim in the ID token is equal to your app's client ID.**
4. Verify that the expiry time (`exp` claim) of the ID token has not passed.
5. The last step is to check whether this user has an account in the application or not, this is done through one of the following values:  
    `sub` claim or `email` claim

- If the “**email”** value or the “**sub”** value **is linked to an account in the application, the session or JWT is returned in the response according to the nature of the authentication mechanism in the application.** If not, he call the registration feature to create an account based on “email” claim.

Example request by Copilot:

```json
POST /someapiendpoint HTTP/1.1
Host: example.com
Authorization: Bearer <YOUR_JWT_TOKEN>
Content-Type: application/json

{
    "header": {
        "alg": "HS256",
        "typ": "JWT"
    },
    "payload": {
        "iss": "Google",
        "sub": "user@example.com",
        "aud": "The Client",
        "exp": 1736399999,   // Example expiration time in Unix timestamp
        "iat": 1672531199,   // Example issued at time in Unix timestamp
        "jti": "unique-identifier"
    },
    "signature": "<YOUR_SIGNATURE>"
}


```

**But, what if the developer doesn’t check the value of the audience for any reason?**

In this case, the ID token of another client can be used to login or to create a new account in the target application, **and it does not have to be specific to the client** that refers to the application we are using. But the ID token must have been signed by Google and still has not exceeded the expiration date!

# **Attack scenario:**

**The attacker can create a client in “Google developers platform“ and configure the Google One Tap Sign-In in his application for the purpose of exploiting a misconfiguration such as “not checking” the audience value to takeover specific accounts;** in case the user registered at the vulnerable application and also registered on the attacker’s application through the Google One Tap Sign-In

![](https://miro.medium.com/v2/resize:fit:700/1*JI8S6sbzv-MRu3ZK_T-3Gg.png)

# **poC**

![](https://miro.medium.com/v2/resize:fit:485/1*m3kWe8h7vjypdSw7XQgL-g.png)



----

I would like to discuss the Facebook OAuth Misconfiguration vulnerability I discovered.

![](https://miro.medium.com/v2/resize:fit:650/0*YShAL-f6m6KYEGuS.png)

In this article, I will talk about how I bypassed Mail verification with Facebook OAuth Misconfiguration.


When I browsed target.com, there were login and register options available. It was an e-shopping store.

First, I tried to register normally and after entering a code that comes to the mail, we can register successfully. The first account I registered: [account-1@target.com](mailto:account-1@target.com). When I try to register again with the same e-mail address, I get an error.

Then I clicked on the Register with Facebook option and on the Facebook page that opened, I clicked on “Edit access”

![](https://miro.medium.com/v2/resize:fit:700/1*t2CuRIzlmNNVukTyZBia_Q.png)

On the page that opens, I changed the button for access to the e-mail address to “I do not accept”.

![](https://miro.medium.com/v2/resize:fit:700/1*lEuyIRMlGEWvHLUwK_JVeA.png)

Then a page appeared asking me to enter the e-mail address again and I entered the e-mail address [account-1@target.com](mailto:account-1@target.com). The registration was successful.

**SignIn With Google**

When I registered with Google, for example, I registered with my gmail address with the mail address [attacker-2@target.com](mailto:attacker-2@target.com). Then a page popped up asking me to enter my first and last name and my email address was on this page

But I cannot change the e-mail address on this page. I right clicked on the mail textbox →review and changed **disabled=“disable” to enabled=“enable”** for the mail box and changed the mail to [attacker-1@target.com](mailto:attacker-1@target.com)

![](https://miro.medium.com/v2/resize:fit:126/1*eDt0zk-7bl5lcYedMBoIDQ.png)

> enabled=”enable”

The registration was successful but unfortunately I did not get the ATO here either. I reported both cases as mail bypass and creating 2 users with the same mail.

Normally it would be an Account takeover but in this scenario I can’t create 2 different accounts with the same email address but after these steps I was able to do it and at the same time I was able to bypass the mail verification. I reported it to the team and they accepted it. They gave me a small bonus of $$ for being a VDP.




---